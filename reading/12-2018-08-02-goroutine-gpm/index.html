<!DOCTYPE html>
  
  
  
  
   
  <html class="no-js" lang="en-us"> 
  

  <head lang="en-us">
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,user-scalable=no,initial-scale=1,maximum-scale=1">
    <meta http-equiv="X-UA-Compatible" content="IE=10" />
    <title>第 12 期 golang 中 goroutine 的调度 - Go Learn</title>
    <meta name="generator" content="Hugo 0.59.1" />

    
    <meta name="description" content="Go Learn Blog">
    
    <link rel="canonical" href="https://bytemode.github.io/reading/12-2018-08-02-goroutine-gpm/">
    
    <meta name="author" content="bytemode">
    

    <meta property="og:url" content="https://bytemode.github.io/reading/12-2018-08-02-goroutine-gpm/">
    <meta property="og:title" content="Go Learn">
    <meta property="og:image" content="https://bytemode.github.io/images/logo.png">
    <meta name="apple-mobile-web-app-title" content="Go Learn">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

    <link rel="shortcut icon" type="image/x-icon" href="https://bytemode.github.io/images/favicon.ico">
    <link rel="icon" type="image/x-icon" href="https://bytemode.github.io/images/favicon.ico">

    <style>
      @font-face {
        font-family: 'Icon';
        src: url('https://bytemode.github.io/fonts/icon.eot');
        src: url('https://bytemode.github.io/fonts/icon.eot')
               format('embedded-opentype'),
             url('https://bytemode.github.io/fonts/icon.woff')
               format('woff'),
             url('https://bytemode.github.io/fonts/icon.ttf')
               format('truetype'),
             url('https://bytemode.github.io/fonts/icon.svg')
               format('svg');
        font-weight: normal;
        font-style: normal;
      }
    </style>

    <link rel="stylesheet" href="https://bytemode.github.io/stylesheets/application.css">
    <link rel="stylesheet" href="https://bytemode.github.io/stylesheets/temporary.css">
    <link rel="stylesheet" href="https://bytemode.github.io/stylesheets/palettes.css">
    <link rel="stylesheet" href="https://bytemode.github.io/icons/style.css">

    
    
    
    <link rel="stylesheet" href="//fonts.googleapis.com/css?family=Ubuntu:400,700|Ubuntu&#43;Mono">
    <style>
      body, input {
        font-family: 'Ubuntu', Helvetica, Arial, sans-serif;
      }
      pre, code {
        font-family: 'Ubuntu Mono', 'Courier New', 'Courier', monospace;
      }
    </style>

    
    <script src="https://bytemode.github.io/javascripts/modernizr.js"></script>
    <script src="https://bytemode.github.io/javascripts/growingio.js"></script>

    
  </head>
  <body class="palette-primary-indigo palette-accent-deep-purple">
    

<div class="backdrop">
    <div class="backdrop-paper"></div>
</div>

<input class="toggle" type="checkbox" id="toggle-drawer">
<input class="toggle" type="checkbox" id="toggle-search">
<label class="toggle-button overlay" for="toggle-drawer"></label>

<header class="header">
    <nav aria-label="Header">
    <div class="bar default zindex11">
        <div class="button button-menu" role="button" aria-label="Menu">
            <label class="toggle-button icon icon-menu" for="toggle-drawer">
        <span></span>
      </label>
        </div>
        <div class="stretch">
            <div class="title">
                第 12 期 golang 中 goroutine 的调度
            </div>
        </div>
        
        <div class="button button-home" role="button" aria-label="Home">
            <a href="https://bytemode.github.io/" title="Home" target="_blank"  class="toggle-button icon icons-home3"></a>
        </div>
          
        <div class="button button-github" role="button" aria-label="GitHub">
            <a href="https://github.com/bytemode" title="@bytemode on GitHub" target="_blank" class="toggle-button icon icon-github"></a>
        </div>
        

        <div class="button button-search" role="button" aria-label="Search">
            <label class="toggle-button icon icon-search" title="Search" for="toggle-search"></label>
        </div>
    </div>
    <div class="bar search">
        <div class="button button-close" role="button" aria-label="Close">
            <label class="toggle-button icon icon-back" for="toggle-search"></label>
        </div>
        <div class="stretch">
            <div class="field">
                <input class="query" type="text" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck>
            </div>
        </div>
        <div class="button button-reset" role="button" aria-label="Search">
            <button class="toggle-button icon icon-close" id="reset-search"></button>
        </div>
    </div>
</nav>
</header>

<main class="main">
    <div class="drawer">
        <nav aria-label="Navigation">
    <a href="https://bytemode.github.io/" class="project">
        <div class="banner">
            
            <div class="logo">
                <img src="https://bytemode.github.io/images/logo.png">
            </div>
            
            <div class="name">
                <strong>Go Learn <span class="version">1.0.0</span></strong> 
                <br> bytemode/bytemodesrc 
            </div>
        </div>
    </a>

    <div class="scrollable">
        <div class="wrapper">
            
            <ul class="repo">
                <li class="repo-download">
                    <a href="https://github.com/bytemode/bytemodesrc/archive/master.zip" target="_blank" title="Download" data-action="download">
                        <i class="icon icon-download"></i> Download
                    </a>
                </li>
                <li class="repo-stars">
                    <a href="https://github.com/bytemode/bytemodesrc/stargazers" target="_blank" title="Stargazers" data-action="star">
                        <i class="icon icon-star"></i> Stars
                        <span class="count">&ndash;</span>
                    </a>
                </li>
            </ul>
            <hr> 

            <div class="toc">
                
                <ul>
                    




<li>
  
    



<a  title="Go源码阅读" href="https://bytemode.github.io/reading/">
	
	Go源码阅读
</a>



  
</li>



<li>
  
    



<a  title="服务器开发" href="https://bytemode.github.io/server/">
	
	服务器开发
</a>



  
</li>



<li>
  
    



<a  title="我的项目" href="https://bytemode.github.io/projects/">
	
	我的项目
</a>



  
</li>



<li>
  
    



<a  title="面试专题" href="https://bytemode.github.io/interview/">
	
	面试专题
</a>



  
</li>



<li>
  
    



<a  title="分享文章" href="https://bytemode.github.io/articles/">
	
	分享文章
</a>



  
</li>



<li>
  
    



<a  title="其他" href="https://bytemode.github.io/other/">
	
	其他
</a>



  
</li>


                </ul>
                 
                <hr>
                <span class="section">关于作者</span>

                <ul>
                     
                    <li>
                        <a href="https://github.com/bytemode" target="_blank" title="@bytemode on GitHub">
              @bytemode on GitHub
            </a>
                    </li>
                     
                </ul>
                
            </div>
        </div>
    </div>
</nav>
    </div>

    <article class="article">
        <div class="wrapper">
            <h1>第 12 期 golang 中 goroutine 的调度 </h1>
            <aside >
                
            </aside>

            

<p>郑宝杨(boya) 2018-08-01 listomebao@gmail.com</p>

<h2 id="阅读源码前可以阅读的资料">阅读源码前可以阅读的资料</h2>

<ul>
<li><a href="http://blog.jobbole.com/35304/">Goroutine背后的系统知识</a></li>
<li><a href="https://github.com/qyuhen/book">golang源码剖析-雨痕老师</a></li>
<li><a href="https://github.com/teh-cmc/go-internals">go-intervals</a></li>
<li><a href="https://tonybai.com/2017/06/23/an-intro-about-goroutine-scheduler/">也谈goroutine调度器</a></li>
</ul>

<h2 id="golang的调度模型概览">golang的调度模型概览</h2>

<p>调度的机制用一句话描述：<br />
runtime准备好G,P,M，然后M绑定P，M从各种队列中获取G，切换到G的执行栈上并执行G上的任务函数，调用goexit做清理工作并回到M，如此反复。</p>

<h3 id="基本概念">基本概念</h3>

<h4 id="m-machine">M（machine）</h4>

<ul>
<li>M代表着真正的执行计算资源，可以认为它就是os thread（系统线程）。</li>
<li>M是真正调度系统的执行者，每个M就像一个勤劳的工作者，总是从各种队列中找到可运行的G，而且这样M的可以同时存在多个。</li>
<li>M在绑定有效的P后，进入调度循环，而且M并不保留G状态，这是G可以跨M调度的基础。</li>
</ul>

<h4 id="p-processor">P（processor）</h4>

<ul>
<li>P表示逻辑processor，是线程M的执行的上下文。</li>
<li>P的最大作用是其拥有的各种G对象队列、链表、cache和状态。</li>
</ul>

<h4 id="g-goroutine">G（goroutine）</h4>

<ul>
<li>调度系统的最基本单位goroutine，存储了goroutine的执行stack信息、goroutine状态以及goroutine的任务函数等。</li>
<li>在G的眼中只有P，P就是运行G的“CPU”。</li>
<li>相当于两级线程</li>
</ul>

<h4 id="线程实现模型">线程实现模型</h4>

<p>来自<code>Go并发编程实战</code></p>

<pre><code>                    +-------+       +-------+      
                    |  KSE  |       |  KSE  |          
                    +-------+       +-------+      
                        |               |                       内核空间
- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -        
                        |               |                       用户空间
                    +-------+       +-------+
                    |   M   |       |   M   |
                    +-------+       +-------+
                  |          |         |          |
              +------+   +------+   +------+   +------+            
              |   P  |   |   P  |   |   P  |   |   P  |
              +------+   +------+   +------+   +------+   
           |     |     |     |     |     |     |     |     | 
         +---+ +---+ +---+ +---+ +---+ +---+ +---+ +---+ +---+ 
         | G | | G | | G | | G | | G | | G | | G | | G | | G | 
         +---+ +---+ +---+ +---+ +---+ +---+ +---+ +---+ +---+ 
</code></pre>

<ul>
<li>KSE（Kernel Scheduling Entity）是内核调度实体<br /></li>
<li>M与P，P与G之前的关联都是动态的，可以变的</li>
</ul>

<h3 id="关系示意图">关系示意图</h3>

<p>来自<code>golang源码剖析</code></p>

<pre><code>                            +-------------------- sysmon ---------------//------+ 
                            |                                                   |
                            |                                                   |
               +---+      +---+-------+                   +--------+          +---+---+
go func() ---&gt; | G | ---&gt; | P | local | &lt;=== balance ===&gt; | global | &lt;--//--- | P | M |
               +---+      +---+-------+                   +--------+          +---+---+
                            |                                 |                 | 
                            |      +---+                      |                 |
                            +----&gt; | M | &lt;--- findrunnable ---+--- steal &lt;--//--+
                                   +---+ 
                                     |
                                   mstart
                                     |
              +--- execute &lt;----- schedule 
              |                      |   
              |                      |
              +--&gt; G.fn --&gt; goexit --+ 


              1. go func() 语气创建G。
              2. 将G放入P的本地队列（或者平衡到全局全局队列）。
              3. 唤醒或新建M来执行任务。
              4. 进入调度循环
              5. 尽力获取可执行的G，并执行
              6. 清理现场并且重新进入调度循环

</code></pre>

<h2 id="gpm的来由">GPM的来由</h2>

<h3 id="特殊的g0和m0">特殊的g0和m0</h3>

<p>g0和m0是在<code>proc.go</code>文件中的两个全局变量，m0就是进程启动后的初始线程，g0也是代表着初始线程的stack<br />
<code>asm_amd64.go</code> &ndash;&gt; runtime·rt0_go(SB)</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go">	<span style="color:#8f5902;font-style:italic">// 程序刚启动的时候必定有一个线程启动（主线程）
</span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// 将当前的栈和资源保存在g0
</span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// 将该线程保存在m0
</span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// tls: Thread Local Storage
</span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// set the per-goroutine and per-mach &#34;registers&#34;
</span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">get_tls</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">BX</span><span style="color:#000;font-weight:bold">)</span>
	<span style="color:#000">LEAQ</span>	<span style="color:#000">runtime</span><span style="color:#a40000">·</span><span style="color:#000">g0</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">SB</span><span style="color:#000;font-weight:bold">),</span> <span style="color:#000">CX</span>
	<span style="color:#000">MOVQ</span>	<span style="color:#000">CX</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">g</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">BX</span><span style="color:#000;font-weight:bold">)</span>
	<span style="color:#000">LEAQ</span>	<span style="color:#000">runtime</span><span style="color:#a40000">·</span><span style="color:#000">m0</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">SB</span><span style="color:#000;font-weight:bold">),</span> <span style="color:#000">AX</span>

	<span style="color:#8f5902;font-style:italic">// save m-&gt;g0 = g0
</span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">MOVQ</span>	<span style="color:#000">CX</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">m_g0</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">AX</span><span style="color:#000;font-weight:bold">)</span>
	<span style="color:#8f5902;font-style:italic">// save m0 to g0-&gt;m
</span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">MOVQ</span>	<span style="color:#000">AX</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">g_m</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">CX</span><span style="color:#000;font-weight:bold">)</span></code></pre></div>
<h3 id="m的一生">M的一生</h3>

<h4 id="m的创建">M的创建</h4>

<p><code>proc.go</code></p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#8f5902;font-style:italic">// Create a new m. It will start off with a call to fn, or else the scheduler.
</span><span style="color:#8f5902;font-style:italic">// fn needs to be static and not a heap allocated closure.
</span><span style="color:#8f5902;font-style:italic">// May run with m.p==nil, so write barriers are not allowed.
</span><span style="color:#8f5902;font-style:italic">//go:nowritebarrierrec
</span><span style="color:#8f5902;font-style:italic">// 创建一个新的m，它将从fn或者调度程序开始
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">newm</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">fn</span> <span style="color:#204a87;font-weight:bold">func</span><span style="color:#000;font-weight:bold">(),</span> <span style="color:#000">_p_</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">p</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
	<span style="color:#8f5902;font-style:italic">// 根据fn和p和绑定一个m对象
</span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">mp</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">allocm</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">_p_</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">fn</span><span style="color:#000;font-weight:bold">)</span>
	<span style="color:#8f5902;font-style:italic">// 设置当前m的下一个p为_p_
</span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">mp</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">nextp</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">set</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">_p_</span><span style="color:#000;font-weight:bold">)</span>
	<span style="color:#000">mp</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">sigmask</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">initSigmask</span>
	<span style="color:#ce5c00;font-weight:bold">...</span>
	<span style="color:#8f5902;font-style:italic">// 真正的分配os thread
</span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">newm1</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">mp</span><span style="color:#000;font-weight:bold">)</span>
<span style="color:#000;font-weight:bold">}</span></code></pre></div><div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">newm1</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">mp</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">m</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
	<span style="color:#8f5902;font-style:italic">// 对cgo的处理
</span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#ce5c00;font-weight:bold">...</span>
	<span style="color:#000">execLock</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">rlock</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#8f5902;font-style:italic">// Prevent process clone.
</span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// 创建一个系统线程
</span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">newosproc</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">mp</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">unsafe</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Pointer</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">mp</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">g0</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">stack</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">hi</span><span style="color:#000;font-weight:bold">))</span>
	<span style="color:#000">execLock</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">runlock</span><span style="color:#000;font-weight:bold">()</span>
<span style="color:#000;font-weight:bold">}</span></code></pre></div>
<h4 id="状态">状态</h4>

<pre><code>       mstart
          |
          v        找不到可执行任务，gc STW，
      +------+     任务执行时间过长，系统阻塞等   +------+
      | spin | ----------------------------&gt; |unspin| 
      +------+          mstop                +------+
          ^                                      |
          |                                      v
      notewakeup &lt;-------------------------  notesleep
</code></pre>

<h4 id="m的一些问题">M的一些问题</h4>

<p><a href="https://github.com/golang/go/issues/14592">https://github.com/golang/go/issues/14592</a></p>

<h3 id="p的一生">P的一生</h3>

<h4 id="p的创建">P的创建</h4>

<p><code>proc.go</code></p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#8f5902;font-style:italic">// Change number of processors. The world is stopped, sched is locked.
</span><span style="color:#8f5902;font-style:italic">// gcworkbufs are not being modified by either the GC or
</span><span style="color:#8f5902;font-style:italic">// the write barrier code.
</span><span style="color:#8f5902;font-style:italic">// Returns list of Ps with local work, they need to be scheduled by the caller.
</span><span style="color:#8f5902;font-style:italic">// 所有的P都在这个函数分配，不管是最开始的初始化分配，还是后期调整
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">procresize</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">nprocs</span> <span style="color:#204a87;font-weight:bold">int32</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">p</span> <span style="color:#000;font-weight:bold">{</span>
	<span style="color:#000">old</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">gomaxprocs</span>
	<span style="color:#8f5902;font-style:italic">// 如果 gomaxprocs &lt;=0 抛出异常
</span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">old</span> <span style="color:#000;font-weight:bold">&lt;</span> <span style="color:#0000cf;font-weight:bold">0</span> <span style="color:#ce5c00;font-weight:bold">||</span> <span style="color:#000">nprocs</span> <span style="color:#ce5c00;font-weight:bold">&lt;=</span> <span style="color:#0000cf;font-weight:bold">0</span> <span style="color:#000;font-weight:bold">{</span>
		<span style="color:#000">throw</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;procresize: invalid arg&#34;</span><span style="color:#000;font-weight:bold">)</span>
	<span style="color:#000;font-weight:bold">}</span>
  <span style="color:#ce5c00;font-weight:bold">...</span>
	<span style="color:#8f5902;font-style:italic">// Grow allp if necessary.
</span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">nprocs</span> <span style="color:#000;font-weight:bold">&gt;</span> <span style="color:#204a87">int32</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87">len</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">allp</span><span style="color:#000;font-weight:bold">))</span> <span style="color:#000;font-weight:bold">{</span>
		<span style="color:#8f5902;font-style:italic">// Synchronize with retake, which could be running
</span><span style="color:#8f5902;font-style:italic"></span>		<span style="color:#8f5902;font-style:italic">// concurrently since it doesn&#39;t run on a P.
</span><span style="color:#8f5902;font-style:italic"></span>		<span style="color:#000">lock</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">allpLock</span><span style="color:#000;font-weight:bold">)</span>
		<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">nprocs</span> <span style="color:#ce5c00;font-weight:bold">&lt;=</span> <span style="color:#204a87">int32</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87">cap</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">allp</span><span style="color:#000;font-weight:bold">))</span> <span style="color:#000;font-weight:bold">{</span>
			<span style="color:#000">allp</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">allp</span><span style="color:#000;font-weight:bold">[:</span><span style="color:#000">nprocs</span><span style="color:#000;font-weight:bold">]</span>
		<span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">else</span> <span style="color:#000;font-weight:bold">{</span>
			<span style="color:#8f5902;font-style:italic">// 分配nprocs个*p
</span><span style="color:#8f5902;font-style:italic"></span>			<span style="color:#000">nallp</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#204a87">make</span><span style="color:#000;font-weight:bold">([]</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">p</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">nprocs</span><span style="color:#000;font-weight:bold">)</span>
			<span style="color:#8f5902;font-style:italic">// Copy everything up to allp&#39;s cap so we
</span><span style="color:#8f5902;font-style:italic"></span>			<span style="color:#8f5902;font-style:italic">// never lose old allocated Ps.
</span><span style="color:#8f5902;font-style:italic"></span>			<span style="color:#204a87">copy</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">nallp</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">allp</span><span style="color:#000;font-weight:bold">[:</span><span style="color:#204a87">cap</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">allp</span><span style="color:#000;font-weight:bold">)])</span>
			<span style="color:#000">allp</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">nallp</span>
		<span style="color:#000;font-weight:bold">}</span>
		<span style="color:#000">unlock</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">allpLock</span><span style="color:#000;font-weight:bold">)</span>
	<span style="color:#000;font-weight:bold">}</span>

	<span style="color:#8f5902;font-style:italic">// initialize new P&#39;s
</span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000">i</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#204a87">int32</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">);</span> <span style="color:#000">i</span> <span style="color:#000;font-weight:bold">&lt;</span> <span style="color:#000">nprocs</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#000">i</span><span style="color:#ce5c00;font-weight:bold">++</span> <span style="color:#000;font-weight:bold">{</span>
		<span style="color:#000">pp</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">allp</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">]</span>
		<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">pp</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
			<span style="color:#000">pp</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#204a87">new</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">p</span><span style="color:#000;font-weight:bold">)</span>
			<span style="color:#000">pp</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">id</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">i</span>
			<span style="color:#000">pp</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">status</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">_Pgcstop</span>            <span style="color:#8f5902;font-style:italic">// 更改状态
</span><span style="color:#8f5902;font-style:italic"></span>			<span style="color:#000">pp</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">sudogcache</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">pp</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">sudogbuf</span><span style="color:#000;font-weight:bold">[:</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#8f5902;font-style:italic">//将sudogcache指向sudogbuf的起始地址
</span><span style="color:#8f5902;font-style:italic"></span>			<span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000">i</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#204a87;font-weight:bold">range</span> <span style="color:#000">pp</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">deferpool</span> <span style="color:#000;font-weight:bold">{</span>
				<span style="color:#000">pp</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">deferpool</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">pp</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">deferpoolbuf</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">][:</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">]</span>
			<span style="color:#000;font-weight:bold">}</span>
			<span style="color:#000">pp</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">wbBuf</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">reset</span><span style="color:#000;font-weight:bold">()</span>
			<span style="color:#8f5902;font-style:italic">// 将pp保存到allp数组里, allp[i] = pp
</span><span style="color:#8f5902;font-style:italic"></span>			<span style="color:#000">atomicstorep</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">unsafe</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Pointer</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">allp</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">]),</span> <span style="color:#000">unsafe</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Pointer</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pp</span><span style="color:#000;font-weight:bold">))</span>
		<span style="color:#000;font-weight:bold">}</span>
		<span style="color:#ce5c00;font-weight:bold">...</span>
	<span style="color:#000;font-weight:bold">}</span>
  <span style="color:#ce5c00;font-weight:bold">...</span>

	<span style="color:#000">_g_</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">getg</span><span style="color:#000;font-weight:bold">()</span>
	<span style="color:#8f5902;font-style:italic">// 如果当前的M已经绑定P，继续使用，否则将当前的M绑定一个P
</span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">_g_</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">m</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">p</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#0000cf;font-weight:bold">0</span> <span style="color:#ce5c00;font-weight:bold">&amp;&amp;</span> <span style="color:#000">_g_</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">m</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">p</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ptr</span><span style="color:#000;font-weight:bold">().</span><span style="color:#000">id</span> <span style="color:#000;font-weight:bold">&lt;</span> <span style="color:#000">nprocs</span> <span style="color:#000;font-weight:bold">{</span>
		<span style="color:#8f5902;font-style:italic">// continue to use the current P
</span><span style="color:#8f5902;font-style:italic"></span>		<span style="color:#000">_g_</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">m</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">p</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ptr</span><span style="color:#000;font-weight:bold">().</span><span style="color:#000">status</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">_Prunning</span>
	<span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">else</span> <span style="color:#000;font-weight:bold">{</span>
		<span style="color:#8f5902;font-style:italic">// release the current P and acquire allp[0]
</span><span style="color:#8f5902;font-style:italic"></span>		<span style="color:#8f5902;font-style:italic">// 获取allp[0]
</span><span style="color:#8f5902;font-style:italic"></span>		<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">_g_</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">m</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">p</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#0000cf;font-weight:bold">0</span> <span style="color:#000;font-weight:bold">{</span>
			<span style="color:#000">_g_</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">m</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">p</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ptr</span><span style="color:#000;font-weight:bold">().</span><span style="color:#000">m</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">0</span>
		<span style="color:#000;font-weight:bold">}</span>
		<span style="color:#000">_g_</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">m</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">p</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">0</span>
		<span style="color:#000">_g_</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">m</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">mcache</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">nil</span>
		<span style="color:#000">p</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">allp</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">]</span>
		<span style="color:#000">p</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">m</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">0</span>
		<span style="color:#000">p</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">status</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">_Pidle</span>
		<span style="color:#8f5902;font-style:italic">// 将当前的m和p绑定
</span><span style="color:#8f5902;font-style:italic"></span>		<span style="color:#000">acquirep</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">p</span><span style="color:#000;font-weight:bold">)</span>
		<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">trace</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">enabled</span> <span style="color:#000;font-weight:bold">{</span>
			<span style="color:#000">traceGoStart</span><span style="color:#000;font-weight:bold">()</span>
		<span style="color:#000;font-weight:bold">}</span>
	<span style="color:#000;font-weight:bold">}</span>
	<span style="color:#204a87;font-weight:bold">var</span> <span style="color:#000">runnablePs</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">p</span>
	<span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000">i</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">nprocs</span> <span style="color:#ce5c00;font-weight:bold">-</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#000">i</span> <span style="color:#ce5c00;font-weight:bold">&gt;=</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#000">i</span><span style="color:#ce5c00;font-weight:bold">--</span> <span style="color:#000;font-weight:bold">{</span>
		<span style="color:#000">p</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">allp</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">]</span>
		<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">_g_</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">m</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">p</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ptr</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#000">p</span> <span style="color:#000;font-weight:bold">{</span>
			<span style="color:#204a87;font-weight:bold">continue</span>
		<span style="color:#000;font-weight:bold">}</span>
		<span style="color:#000">p</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">status</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">_Pidle</span>
		<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">runqempty</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">p</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#8f5902;font-style:italic">// 将空闲p放入空闲链表
</span><span style="color:#8f5902;font-style:italic"></span>			<span style="color:#000">pidleput</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">p</span><span style="color:#000;font-weight:bold">)</span>
		<span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">else</span> <span style="color:#000;font-weight:bold">{</span>
			<span style="color:#000">p</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">m</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">set</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">mget</span><span style="color:#000;font-weight:bold">())</span>
			<span style="color:#000">p</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">link</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">set</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">runnablePs</span><span style="color:#000;font-weight:bold">)</span>
			<span style="color:#000">runnablePs</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">p</span>
		<span style="color:#000;font-weight:bold">}</span>
	<span style="color:#000;font-weight:bold">}</span>
	<span style="color:#000">stealOrder</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">reset</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87">uint32</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">nprocs</span><span style="color:#000;font-weight:bold">))</span>
	<span style="color:#204a87;font-weight:bold">var</span> <span style="color:#000">int32p</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#204a87;font-weight:bold">int32</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">gomaxprocs</span> <span style="color:#8f5902;font-style:italic">// make compiler check that gomaxprocs is an int32
</span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">atomic</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Store</span><span style="color:#000;font-weight:bold">((</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#204a87;font-weight:bold">uint32</span><span style="color:#000;font-weight:bold">)(</span><span style="color:#000">unsafe</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Pointer</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">int32p</span><span style="color:#000;font-weight:bold">)),</span> <span style="color:#204a87">uint32</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">nprocs</span><span style="color:#000;font-weight:bold">))</span>
	<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">runnablePs</span>
<span style="color:#000;font-weight:bold">}</span></code></pre></div>
<p>所有的P在程序启动的时候就设置好了，并用一个allp slice维护，可以调用runtime.GOMAXPROCS调整P的个数，虽然代价很大</p>

<h4 id="状态转换">状态转换</h4>

<pre><code>                                            acquirep(p)        
                          不需要使用的P       P和M绑定的时候       进入系统调用       procresize()
new(p)  -----+        +---------------+     +-----------+     +------------+    +----------+
            |         |               |     |           |     |            |    |          |
            |   +------------+    +---v--------+    +---v--------+    +----v-------+    +--v---------+
            +--&gt;|  _Pgcstop  |    |    _Pidle  |    |  _Prunning |    |  _Psyscall |    |   _Pdead   |
                +------^-----+    +--------^---+    +--------^---+    +------------+    +------------+
                       |            |     |            |     |            |
                       +------------+     +------------+     +------------+
                           GC结束            releasep()        退出系统调用
                                            P和M解绑                      
</code></pre>

<p>P的数量默认等于cpu的个数，很多人认为runtime.GOMAXPROCS可以限制系统线程的数量，但这是错误的，M是按需创建的，和runtime.GOMAXPROCS没有关系。</p>

<h3 id="g的一生">G的一生</h3>

<h4 id="g的创建">G的创建</h4>

<p><code>proc.go</code></p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#8f5902;font-style:italic">// Create a new g running fn with siz bytes of arguments.
</span><span style="color:#8f5902;font-style:italic">// Put it on the queue of g&#39;s waiting to run.
</span><span style="color:#8f5902;font-style:italic">// The compiler turns a go statement into a call to this.
</span><span style="color:#8f5902;font-style:italic">// Cannot split the stack because it assumes that the arguments
</span><span style="color:#8f5902;font-style:italic">// are available sequentially after &amp;fn; they would not be
</span><span style="color:#8f5902;font-style:italic">// copied if a stack split occurred.
</span><span style="color:#8f5902;font-style:italic">//go:nosplit
</span><span style="color:#8f5902;font-style:italic">// 新建一个goroutine，
</span><span style="color:#8f5902;font-style:italic">// 􏳄 用fn + PtrSize 获取第一个参数的地址，也就是argp
</span><span style="color:#8f5902;font-style:italic">// 用siz - 8 获取pc地址
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">newproc</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">siz</span> <span style="color:#204a87;font-weight:bold">int32</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">fn</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">funcval</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
	<span style="color:#000">argp</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">add</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">unsafe</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Pointer</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">fn</span><span style="color:#000;font-weight:bold">),</span> <span style="color:#000">sys</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PtrSize</span><span style="color:#000;font-weight:bold">)</span>
	<span style="color:#000">pc</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">getcallerpc</span><span style="color:#000;font-weight:bold">()</span>
	<span style="color:#8f5902;font-style:italic">// 用g0的栈创建G对象
</span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">systemstack</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">func</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
		<span style="color:#000">newproc1</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">fn</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#204a87;font-weight:bold">uint8</span><span style="color:#000;font-weight:bold">)(</span><span style="color:#000">argp</span><span style="color:#000;font-weight:bold">),</span> <span style="color:#000">siz</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">pc</span><span style="color:#000;font-weight:bold">)</span>
	<span style="color:#000;font-weight:bold">})</span>
<span style="color:#000;font-weight:bold">}</span></code></pre></div><div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#8f5902;font-style:italic">// Create a new g running fn with narg bytes of arguments starting
</span><span style="color:#8f5902;font-style:italic">// at argp. callerpc is the address of the go statement that created
</span><span style="color:#8f5902;font-style:italic">// this. The new g is put on the queue of g&#39;s waiting to run.
</span><span style="color:#8f5902;font-style:italic">// 根据函数参数和函数地址，创建一个新的G，然后将这个G加入队列等待运行
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">newproc1</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">fn</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">funcval</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">argp</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#204a87;font-weight:bold">uint8</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">narg</span> <span style="color:#204a87;font-weight:bold">int32</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">callerpc</span> <span style="color:#204a87;font-weight:bold">uintptr</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
	<span style="color:#000">_g_</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">getg</span><span style="color:#000;font-weight:bold">()</span>

	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">fn</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
		<span style="color:#000">_g_</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">m</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">throwing</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">1</span> <span style="color:#8f5902;font-style:italic">// do not dump full stacks
</span><span style="color:#8f5902;font-style:italic"></span>		<span style="color:#000">throw</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;go of nil func value&#34;</span><span style="color:#000;font-weight:bold">)</span>
	<span style="color:#000;font-weight:bold">}</span>
	<span style="color:#000">_g_</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">m</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">locks</span><span style="color:#ce5c00;font-weight:bold">++</span> <span style="color:#8f5902;font-style:italic">// disable preemption because it can be holding p in a local var
</span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">siz</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">narg</span>
	<span style="color:#000">siz</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">siz</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#0000cf;font-weight:bold">7</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">&amp;^</span> <span style="color:#0000cf;font-weight:bold">7</span>

	<span style="color:#8f5902;font-style:italic">// We could allocate a larger initial stack if necessary.
</span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// Not worth it: this is almost always an error.
</span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// 4*sizeof(uintreg): extra space added below
</span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// sizeof(uintreg): caller&#39;s LR (arm) or return address (x86, in gostartcall).
</span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// 如果函数的参数大小比2048大的话，直接panic
</span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">siz</span> <span style="color:#ce5c00;font-weight:bold">&gt;=</span> <span style="color:#000">_StackMin</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">4</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">sys</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">RegSize</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#000">sys</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">RegSize</span> <span style="color:#000;font-weight:bold">{</span>
		<span style="color:#000">throw</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;newproc: function arguments too large for new goroutine&#34;</span><span style="color:#000;font-weight:bold">)</span>
	<span style="color:#000;font-weight:bold">}</span>

	<span style="color:#8f5902;font-style:italic">// 从m中获取p
</span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">_p_</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">_g_</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">m</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">p</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ptr</span><span style="color:#000;font-weight:bold">()</span>
	<span style="color:#8f5902;font-style:italic">// 从gfree list获取g
</span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">newg</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">gfget</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">_p_</span><span style="color:#000;font-weight:bold">)</span>
	<span style="color:#8f5902;font-style:italic">// 如果没获取到g，则新建一个
</span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">newg</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
		<span style="color:#000">newg</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">malg</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">_StackMin</span><span style="color:#000;font-weight:bold">)</span>
		<span style="color:#000">casgstatus</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">newg</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">_Gidle</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">_Gdead</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#8f5902;font-style:italic">//将g的状态改为_Gdead
</span><span style="color:#8f5902;font-style:italic"></span>		<span style="color:#8f5902;font-style:italic">// 添加到allg数组，防止gc扫描清除掉
</span><span style="color:#8f5902;font-style:italic"></span>		<span style="color:#000">allgadd</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">newg</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#8f5902;font-style:italic">// publishes with a g-&gt;status of Gdead so GC scanner doesn&#39;t look at uninitialized stack.
</span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000;font-weight:bold">}</span>
	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">newg</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">stack</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">hi</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#0000cf;font-weight:bold">0</span> <span style="color:#000;font-weight:bold">{</span>
		<span style="color:#000">throw</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;newproc1: newg missing stack&#34;</span><span style="color:#000;font-weight:bold">)</span>
	<span style="color:#000;font-weight:bold">}</span>

	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">readgstatus</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">newg</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#000">_Gdead</span> <span style="color:#000;font-weight:bold">{</span>
		<span style="color:#000">throw</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;newproc1: new g is not Gdead&#34;</span><span style="color:#000;font-weight:bold">)</span>
	<span style="color:#000;font-weight:bold">}</span>

	<span style="color:#000">totalSize</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#0000cf;font-weight:bold">4</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">sys</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">RegSize</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#204a87">uintptr</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">siz</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#000">sys</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">MinFrameSize</span> <span style="color:#8f5902;font-style:italic">// extra space in case of reads slightly beyond frame
</span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">totalSize</span> <span style="color:#ce5c00;font-weight:bold">+=</span> <span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#000">totalSize</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">sys</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">SpAlign</span> <span style="color:#ce5c00;font-weight:bold">-</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">)</span>                  <span style="color:#8f5902;font-style:italic">// align to spAlign
</span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">sp</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">newg</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">stack</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">hi</span> <span style="color:#ce5c00;font-weight:bold">-</span> <span style="color:#000">totalSize</span>
	<span style="color:#000">spArg</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">sp</span>
	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">usesLR</span> <span style="color:#000;font-weight:bold">{</span>
		<span style="color:#8f5902;font-style:italic">// caller&#39;s LR
</span><span style="color:#8f5902;font-style:italic"></span>		<span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#204a87;font-weight:bold">uintptr</span><span style="color:#000;font-weight:bold">)(</span><span style="color:#000">unsafe</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Pointer</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">sp</span><span style="color:#000;font-weight:bold">))</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">0</span>
		<span style="color:#000">prepGoExitFrame</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">sp</span><span style="color:#000;font-weight:bold">)</span>
		<span style="color:#000">spArg</span> <span style="color:#ce5c00;font-weight:bold">+=</span> <span style="color:#000">sys</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">MinFrameSize</span>
	<span style="color:#000;font-weight:bold">}</span>
	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">narg</span> <span style="color:#000;font-weight:bold">&gt;</span> <span style="color:#0000cf;font-weight:bold">0</span> <span style="color:#000;font-weight:bold">{</span>
		<span style="color:#8f5902;font-style:italic">// copy参数
</span><span style="color:#8f5902;font-style:italic"></span>		<span style="color:#000">memmove</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">unsafe</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Pointer</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">spArg</span><span style="color:#000;font-weight:bold">),</span> <span style="color:#000">unsafe</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Pointer</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">argp</span><span style="color:#000;font-weight:bold">),</span> <span style="color:#204a87">uintptr</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">narg</span><span style="color:#000;font-weight:bold">))</span>
		<span style="color:#8f5902;font-style:italic">// This is a stack-to-stack copy. If write barriers
</span><span style="color:#8f5902;font-style:italic"></span>		<span style="color:#8f5902;font-style:italic">// are enabled and the source stack is grey (the
</span><span style="color:#8f5902;font-style:italic"></span>		<span style="color:#8f5902;font-style:italic">// destination is always black), then perform a
</span><span style="color:#8f5902;font-style:italic"></span>		<span style="color:#8f5902;font-style:italic">// barrier copy. We do this *after* the memmove
</span><span style="color:#8f5902;font-style:italic"></span>		<span style="color:#8f5902;font-style:italic">// because the destination stack may have garbage on
</span><span style="color:#8f5902;font-style:italic"></span>		<span style="color:#8f5902;font-style:italic">// it.
</span><span style="color:#8f5902;font-style:italic"></span>		<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">writeBarrier</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">needed</span> <span style="color:#ce5c00;font-weight:bold">&amp;&amp;</span> <span style="color:#000;font-weight:bold">!</span><span style="color:#000">_g_</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">m</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">curg</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">gcscandone</span> <span style="color:#000;font-weight:bold">{</span>
			<span style="color:#000">f</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">findfunc</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">fn</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">fn</span><span style="color:#000;font-weight:bold">)</span>
			<span style="color:#000">stkmap</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">stackmap</span><span style="color:#000;font-weight:bold">)(</span><span style="color:#000">funcdata</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">f</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">_FUNCDATA_ArgsPointerMaps</span><span style="color:#000;font-weight:bold">))</span>
			<span style="color:#8f5902;font-style:italic">// We&#39;re in the prologue, so it&#39;s always stack map index 0.
</span><span style="color:#8f5902;font-style:italic"></span>			<span style="color:#000">bv</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">stackmapdata</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">stkmap</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">)</span>
			<span style="color:#000">bulkBarrierBitmap</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">spArg</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">spArg</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87">uintptr</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">narg</span><span style="color:#000;font-weight:bold">),</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">bv</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">bytedata</span><span style="color:#000;font-weight:bold">)</span>
		<span style="color:#000;font-weight:bold">}</span>
	<span style="color:#000;font-weight:bold">}</span>

	<span style="color:#000">memclrNoHeapPointers</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">unsafe</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Pointer</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">newg</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">sched</span><span style="color:#000;font-weight:bold">),</span> <span style="color:#000">unsafe</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Sizeof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">newg</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">sched</span><span style="color:#000;font-weight:bold">))</span>
	<span style="color:#000">newg</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">sched</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">sp</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">sp</span>
	<span style="color:#000">newg</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">stktopsp</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">sp</span>
	<span style="color:#8f5902;font-style:italic">// 保存goexit的地址到sched.pc
</span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">newg</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">sched</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">pc</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">funcPC</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">goexit</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#000">sys</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PCQuantum</span> <span style="color:#8f5902;font-style:italic">// +PCQuantum so that previous instruction is in same function
</span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">newg</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">sched</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">g</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">guintptr</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">unsafe</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Pointer</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">newg</span><span style="color:#000;font-weight:bold">))</span>
	<span style="color:#000">gostartcallfn</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">newg</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">sched</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">fn</span><span style="color:#000;font-weight:bold">)</span>
	<span style="color:#000">newg</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">gopc</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">callerpc</span>
	<span style="color:#000">newg</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">startpc</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">fn</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">fn</span>
	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">_g_</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">m</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">curg</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
		<span style="color:#000">newg</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">labels</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">_g_</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">m</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">curg</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">labels</span>
	<span style="color:#000;font-weight:bold">}</span>
	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">isSystemGoroutine</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">newg</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
		<span style="color:#000">atomic</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Xadd</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">sched</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ngsys</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#ce5c00;font-weight:bold">+</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">)</span>
	<span style="color:#000;font-weight:bold">}</span>
	<span style="color:#000">newg</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">gcscanvalid</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">false</span>
	<span style="color:#8f5902;font-style:italic">// 更改当前g的状态为_Grunnable
</span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">casgstatus</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">newg</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">_Gdead</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">_Grunnable</span><span style="color:#000;font-weight:bold">)</span>

	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">_p_</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">goidcache</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#000">_p_</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">goidcacheend</span> <span style="color:#000;font-weight:bold">{</span>
		<span style="color:#8f5902;font-style:italic">// Sched.goidgen is the last allocated id,
</span><span style="color:#8f5902;font-style:italic"></span>		<span style="color:#8f5902;font-style:italic">// this batch must be [sched.goidgen+1, sched.goidgen+GoidCacheBatch].
</span><span style="color:#8f5902;font-style:italic"></span>		<span style="color:#8f5902;font-style:italic">// At startup sched.goidgen=0, so main goroutine receives goid=1.
</span><span style="color:#8f5902;font-style:italic"></span>		<span style="color:#000">_p_</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">goidcache</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">atomic</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Xadd64</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">sched</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">goidgen</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">_GoidCacheBatch</span><span style="color:#000;font-weight:bold">)</span>
		<span style="color:#000">_p_</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">goidcache</span> <span style="color:#ce5c00;font-weight:bold">-=</span> <span style="color:#000">_GoidCacheBatch</span> <span style="color:#ce5c00;font-weight:bold">-</span> <span style="color:#0000cf;font-weight:bold">1</span>
		<span style="color:#000">_p_</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">goidcacheend</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">_p_</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">goidcache</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#000">_GoidCacheBatch</span>
	<span style="color:#000;font-weight:bold">}</span>
	<span style="color:#8f5902;font-style:italic">// 生成唯一的goid
</span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">newg</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">goid</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#204a87">int64</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">_p_</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">goidcache</span><span style="color:#000;font-weight:bold">)</span>
	<span style="color:#000">_p_</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">goidcache</span><span style="color:#ce5c00;font-weight:bold">++</span>
	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">raceenabled</span> <span style="color:#000;font-weight:bold">{</span>
		<span style="color:#000">newg</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">racectx</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">racegostart</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">callerpc</span><span style="color:#000;font-weight:bold">)</span>
	<span style="color:#000;font-weight:bold">}</span>
	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">trace</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">enabled</span> <span style="color:#000;font-weight:bold">{</span>
		<span style="color:#000">traceGoCreate</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">newg</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">newg</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">startpc</span><span style="color:#000;font-weight:bold">)</span>
	<span style="color:#000;font-weight:bold">}</span>
	<span style="color:#8f5902;font-style:italic">// 将当前新生成的g，放入队列
</span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">runqput</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">_p_</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">newg</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">true</span><span style="color:#000;font-weight:bold">)</span>

	<span style="color:#8f5902;font-style:italic">// 如果有空闲的p 且 m没有处于自旋状态 且 main goroutine已经启动，那么唤醒某个m来执行任务
</span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">atomic</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Load</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">sched</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">npidle</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#0000cf;font-weight:bold">0</span> <span style="color:#ce5c00;font-weight:bold">&amp;&amp;</span> <span style="color:#000">atomic</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Load</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">sched</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">nmspinning</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#0000cf;font-weight:bold">0</span> <span style="color:#ce5c00;font-weight:bold">&amp;&amp;</span> <span style="color:#000">mainStarted</span> <span style="color:#000;font-weight:bold">{</span>
		<span style="color:#000">wakep</span><span style="color:#000;font-weight:bold">()</span>
	<span style="color:#000;font-weight:bold">}</span>
	<span style="color:#000">_g_</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">m</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">locks</span><span style="color:#ce5c00;font-weight:bold">--</span>
	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">_g_</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">m</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">locks</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#0000cf;font-weight:bold">0</span> <span style="color:#ce5c00;font-weight:bold">&amp;&amp;</span> <span style="color:#000">_g_</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">preempt</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#8f5902;font-style:italic">// restore the preemption request in case we&#39;ve cleared it in newstack
</span><span style="color:#8f5902;font-style:italic"></span>		<span style="color:#000">_g_</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">stackguard0</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">stackPreempt</span>
	<span style="color:#000;font-weight:bold">}</span>
<span style="color:#000;font-weight:bold">}</span></code></pre></div>
<h4 id="g的状态图">G的状态图</h4>

<pre><code>                                                      +------------+
                                      ready           |            |
                                  +------------------ |  _Gwaiting |
                                  |                   |            |
                                  |                   +------------+
                                  |                         ^ park_m
                                  V                         | 
  +------------+            +------------+  execute   +------------+            +------------+    
  |            |  newproc   |            | ---------&gt; |            |   goexit   |            |
  |  _Gidle    | ---------&gt; | _Grunnable |  yield     | _Grunning  | ---------&gt; |   _Gdead   |      
  |            |            |            | &lt;--------- |            |            |            |
  +------------+            +-----^------+            +------------+            +------------+
                                  |         entersyscall |      ^ 
                                  |                      V      | existsyscall
                                  |                   +------------+
                                  |   existsyscall    |            |
                                  +------------------ |  _Gsyscall |
                                                      |            |
                                                      +------------+

</code></pre>

<p>新建的G都是_Grunnable的，新建G的时候优先从gfree list从获取G，这样可以复用G，所以上图的状态不是完整的，_Gdead通过newproc会变为_Grunnable，
通过go func()的语法新建的G，并不是直接运行，而是放入可运行的队列中，什么时候运行用于并不能决定，而是搞调度系统去自发的运行。</p>

<h2 id="观看视频">观看视频</h2>


<div style="position: relative; padding-bottom: 56.25%; height: 0; overflow: hidden;">
  <iframe src="https://www.youtube.com/embed/98pIzaOeD2k" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; border:0;" allowfullscreen title="YouTube Video"></iframe>
</div>



			


            <aside class="copyright" role="note">
                 &copy; 2019 Released under the MIT license &ndash;  - By Stephen Sun.
            </aside>

            <footer class="footer">
                

<nav class="pagination" aria-label="Footer">
  <div class="previous">
  
      <a href="https://bytemode.github.io/interview/interview-golang-language/" title="Golang语言">
        <span class="direction">
          Previous
        </span>
        <div class="page">
          <div class="button button-previous" role="button" aria-label="Previous">
            <i class="icon icon-back"></i>
          </div>
          <div class="stretch">
            <div class="title">
              Golang语言
            </div>
          </div>
        </div>
      </a>
  
  </div>

  <div class="next">
  
      <a href="https://bytemode.github.io/reading/13-2018-08-09-kubernetes-guide/" title="第 13 期 Kubernetes 入门指南">
        <span class="direction">
          Next
        </span>
        <div class="page">
          <div class="stretch">
            <div class="title">
              第 13 期 Kubernetes 入门指南
            </div>
          </div>
          <div class="button button-next" role="button" aria-label="Next">
            <i class="icon icon-forward"></i>
          </div>
        </div>
      </a>
  
  </div>
</nav>





            </footer>
        </div>
    </article>

    <div class="results" role="status" aria-live="polite">
        <div class="scrollable">
            <div class="wrapper">
                <div class="meta"></div>
                <div class="list"></div>
            </div>
        </div>
    </div>
</main>

    <script>
    
      var base_url = 'https:\/\/bytemode.github.io\/';
      var repo_id  = 'bytemode\/bytemodesrc';
    
    </script>

    <script src="https://bytemode.github.io/javascripts/application.js"></script>
    

    <script>
      /* Add headers to scrollspy */
      var headers   = document.getElementsByTagName("h2");
      var scrollspy = document.getElementById('scrollspy');

      if(scrollspy) {
        if(headers.length > 0) {
          for(var i = 0; i < headers.length; i++) {
            var li = document.createElement("li");
            li.setAttribute("class", "anchor");

            var a  = document.createElement("a");
            a.setAttribute("href", "#" + headers[i].id);
            a.setAttribute("title", headers[i].innerHTML);
            a.innerHTML = headers[i].innerHTML;

            li.appendChild(a)
            scrollspy.appendChild(li);
          }
        } else {
          scrollspy.parentElement.removeChild(scrollspy)
        }


        /* Add permanent link next to the headers */
        var headers = document.querySelectorAll("h1, h2, h3, h4, h5, h6");

        for(var i = 0; i < headers.length; i++) {
            var a = document.createElement("a");
            a.setAttribute("class", "headerlink");
            a.setAttribute("href", "#" + headers[i].id);
            a.setAttribute("title", "Permanent link")
            a.innerHTML = " ";
            headers[i].appendChild(a);
        }
      }
    </script>

    

    <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.8.0/highlight.min.js"></script>
    <script>hljs.initHighlightingOnLoad();</script>
  </body>
</html>

